
{% set montant_ht = (facture.totalDu / 100) / (taxe_assureur.tauxIARD + 1) %}
{% set montant_taxe = (montant_ht * taxe_assureur.tauxIARD) %}
{% set montant_ttc = montant_ht + montant_taxe %}

{% if facture.destination == 4 %}
    {% set com_ttc = 0 %}
    {% set com_ttc_payee = 0 %}
    {% set com_ttc_solde = 0 %}
    {% set com_ht = 0 %}
    {% set montant_taxe_courtier = 0 %}
    {% set montant_taxe_assureur = 0 %}
    {% set com_partageable = 0 %}
    {% set com_partenaire = 0 %}
    {% set com_partenaire_payee = 0 %}
    {% set com_partenaire_solde = 0 %}
    {% set montant_pret_a_payer = 0 %}

    {% for i in 0..facture.elementFactures|length - 1 %}
        {% set police = facture.elementFactures[i].police %}
        {% set com_ttc = com_ttc + (police.calc_revenu_ttc / 100) %}
        {% set com_ttc_payee = com_ttc_payee + (police.calc_revenu_ttc_encaisse / 100) %}
        {% set com_ttc_solde = com_ttc_solde + (police.calc_revenu_ttc_solde_restant_du / 100) %}
        {% set com_ht = com_ht + (police.calc_revenu_ht / 100) %}
        {% set montant_taxe_courtier = montant_taxe_courtier + (police.calc_taxes_courtier / 100) %}
        {% set montant_taxe_assureur = montant_taxe_assureur + (police.calc_taxes_assureurs / 100) %}
        {% set com_partageable = com_partageable + (police.calc_revenu_partageable / 100) %}
        {% set com_partenaire = com_partenaire + (police.calc_retrocom / 100) %}
        {% set com_partenaire_payee = com_partenaire_payee + (police.calc_retrocom_payees / 100) %}
        {% set com_partenaire_solde = com_partenaire_solde + (police.calc_retrocom_solde / 100) %}
        {% set montant_pret_a_payer = montant_pret_a_payer + (facture.elementFactures[i].montant / 100) %}
    {% endfor %}
    
    {# NOTE DE CREDIT (RETROCOMMISSION) #}
    {# Synthèse des totaux #}
    <table class="tableau-bordure-zero centre marge-top-moyen texte-taille-normale">
        <tr>
            <td class="texte-centre texte-bleu" colspan="2">Synthèse</td>
        </tr>
        <tr>
            <td class="tab-titre-label"><strong>Libellés</strong></td>
            <td class="tab-titre-valeur"><strong>Valeurs</strong></td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Commission totale (ttc)</td>
            <td class="tab-ligne-valeur">{{com_ttc|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr class="texte-rouge">
            <td class="tab-ligne-label"> - Taxes ({{taxe_assureur.nom}} @{{ taxe_assureur.tauxIARD * 100}}%)</td>
            <td class="tab-ligne-valeur">-{{montant_taxe_assureur|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Commission totale hors taxes</td>
            <td class="tab-ligne-valeur">{{com_ht|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr class="texte-rouge">
            <td class="tab-ligne-label"> - Autres Frais ({{taxe_courtier.nom}} @{{ taxe_courtier.taux * 100}}%)</td>
            <td class="tab-ligne-valeur">-{{montant_taxe_courtier|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Commission à partager avec {{facture.partenaire.nom}}</td>
            <td class="tab-ligne-valeur">{{com_partageable|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Part dûe à {{facture.partenaire.nom}} ({{facture.partenaire.part * 100}}%)</td>
            <td class="tab-ligne-valeur">{{com_partenaire|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr class="texte-rouge">
            <td class="tab-ligne-label"> - Montant total déjà payé à {{facture.partenaire.nom}}</td>
            <td class="tab-ligne-valeur">-{{com_partenaire_payee|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Solde restant dû à {{facture.partenaire.nom}}</td>
            <td class="tab-ligne-valeur">{{com_partenaire_solde|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr class="bg-sombre">
            <td class="tab-ligne-label">Montant à payer à {{facture.partenaire.nom}}</td>
            <td class="tab-ligne-valeur">{{montant_pret_a_payer|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
    </table>
{% elseif facture.destination == 3 or facture.destination == 0 %}
    {% set nb_avenant = facture.elementFactures|length %}
    {% set primes_totale = 0 %}
    {% set primes_nettes = 0 %}
    {% set com_ht = 0 %}
    {% set montant_taxe_courtier = 0 %}
    {% set montant_taxe_assureur = 0 %}
    {% set montant_taxe_courtier_payee = 0 %}
    {% set montant_taxe_courtier_solde = 0 %}
    {% set montant_taxe_assureur_payee = 0 %}
    {% set montant_taxe_assureur_solde = 0 %}
    {% set montant_pret_a_payer = 0 %}

    {% for i in 0..facture.elementFactures|length - 1 %}
        {% set tranche = facture.elementFactures[i].tranche %}
        {% set primes_totale = primes_totale + (tranche.primeTotaleTranche / 100) %}
        {% set primes_nettes = primes_nettes + (tranche.primeNetteTranche / 100) %}
        {% set com_ht = com_ht + (tranche.comLocale / 100) %}
        {% if facture.destination == 0 %} {# ARCA #}
            {% set montant_taxe_courtier = montant_taxe_courtier + (tranche.taxeCourtierTotale / 100) %}
            {% set montant_taxe_courtier_payee = montant_taxe_courtier_payee + (tranche.taxeCourtierPayee / 100) %}
            {% set montant_taxe_courtier_solde = montant_taxe_courtier_solde + (tranche.taxeCourtierSolde / 100) %}
        {% elseif facture.destination == 3 %} {# TVA #}
            {% set montant_taxe_assureur = montant_taxe_assureur + (tranche.taxeAssureurTotale / 100) %}
            {% set montant_taxe_assureur_payee = montant_taxe_assureur_payee + (tranche.taxeAssureurPayee / 100) %}
            {% set montant_taxe_assureur_solde = montant_taxe_assureur_solde + (tranche.taxeAssureurSolde / 100) %}
        {% endif %}
        {% set montant_pret_a_payer = montant_pret_a_payer + (facture.elementFactures[i].montant / 100) %}
    {% endfor %}
    {# NOTE DE CREDIT ARCA #}
    <table class="tableau-bordure-zero centre marge-top-large texte-taille-normale">
        <tr>
            <td class="texte-centre texte-bleu" colspan="2">Synthèse</td>
        </tr>
        <tr>
            <td class="tab-titre-label"><strong>Libellé</strong></td>
            <td class="tab-titre-valeur"><strong>Valeurs</strong></td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Nombre total d'opérations / avénants</td>
            <td class="tab-ligne-valeur">{{nb_avenant|number_format('0', ',', '.')}} avénant(s)</td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Primes totales générées</td>
            <td class="tab-ligne-valeur">{{primes_totale|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Primes nettes après deduction des taxes</td>
            <td class="tab-ligne-valeur">{{primes_nettes|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Commissions totales hors taxes</td>
            <td class="tab-ligne-valeur">{{com_ht|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        {% if facture.type == 3 %} {# ARCA #}
            <tr>
                <td class="tab-ligne-label">Frais {{taxe_courtier.nom}} ({{(taxe_courtier.taux * 100)|number_format(0, ',', '.')}}%)</td>
                <td class="tab-ligne-valeur">{{montant_taxe_courtier|format_currency(monnaie, {fraction_digit: 2})}}</td>
            </tr>
            <tr class="texte-rouge">
                <td class="tab-ligne-label"> - Frais {{taxe_courtier.nom}} déjà payés</td>
                <td class="tab-ligne-valeur">-{{montant_taxe_courtier_payee|format_currency(monnaie, {fraction_digit: 2})}}</td>
            </tr>
            <tr>
                <td class="tab-ligne-label">Solde restant dû</td>
                <td class="tab-ligne-valeur">{{montant_taxe_courtier_solde|format_currency(monnaie, {fraction_digit: 2})}}</td>
            </tr>
            <tr class="bg-sombre">
                <td class="tab-ligne-label">Total à payer à {{taxe_courtier.organisation}}</td>
                <td class="tab-ligne-valeur">{{montant_pret_a_payer|format_currency(monnaie, {fraction_digit: 2})}}</td>
            </tr>
        {% elseif facture.type == 2 %} {# TVA #}
            <tr>
                <td class="tab-ligne-label">{{taxe_assureur.nom}} ({{(taxe_assureur.tauxIARD * 100)|number_format(0, ',', '.')}}%)</td>
                <td class="tab-ligne-valeur">{{montant_taxe_assureur|format_currency(monnaie, {fraction_digit: 2})}}</td>
            </tr>
            <tr class="texte-rouge">
                <td class="tab-ligne-label"> - {{taxe_assureur.nom}} déjà payés</td>
                <td class="tab-ligne-valeur">-{{montant_taxe_assureur_payee|format_currency(monnaie, {fraction_digit: 2})}}</td>
            </tr>
            <tr>
                <td class="tab-ligne-label">Solde restant dû</td>
                <td class="tab-ligne-valeur">{{montant_taxe_assureur_solde|format_currency(monnaie, {fraction_digit: 2})}}</td>
            </tr>
            <tr class="bg-sombre">
                <td class="tab-ligne-label">Total à payer à {{taxe_assureur.organisation}}</td>
                <td class="tab-ligne-valeur">{{montant_pret_a_payer|format_currency(monnaie, {fraction_digit: 2})}}</td>
            </tr>
        {% endif %}
        
    </table>
{% elseif facture.destination == 1 or facture.destination == 2 %}
    {# NOTE DE DEBIT POUR COMMISSION OU FRAIS DE GESTION #}
    {# Synthèse des totaux #}
    <table class="tableau-bordure-zero centre marge-top-large texte-taille-normale">
        <tr>
            <td class="texte-centre texte-bleu" colspan="2">Synthèse</td>
        </tr>
        <tr>
            <td class="tab-titre-label"><strong>Libellé</strong></td>
            <td class="tab-titre-valeur"><strong>Valeurs</strong></td>
        </tr>
        <tr>
            <td class="tab-ligne-label">Montant total hors taxes</td>
            <td class="tab-ligne-valeur">{{montant_ht|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr>
            <td class="tab-ligne-label">{{taxe_assureur.nom}} ({{(taxe_assureur.tauxIARD * 100)|number_format(0, ',', '.')}}%)</td>
            <td class="tab-ligne-valeur">{{montant_taxe|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
        <tr class="bg-sombre">
            <td class="tab-ligne-label">Total à payer</td>
            <td class="tab-ligne-valeur">{{montant_ttc|format_currency(monnaie, {fraction_digit: 2})}}</td>
        </tr>
    </table>
{% endif %}